<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>PDF !!!</title>
<style>
  :root{--bg:#dfe6e3;--ink:#000;--barH:22px;--fs:10px;--ease:cubic-bezier(.22,.61,.36,1)}
  html,body{height:100%;margin:0;background:var(--bg);color:var(--ink);
    font:var(--fs)/1.15 ui-monospace,Menlo,Consolas,monospace;letter-spacing:.1px;overflow:hidden}
  #desktop{position:fixed;inset:0;display:flex;flex-direction:column;background:
    linear-gradient(0deg,transparent 50%,rgba(0,0,0,.03) 50%) 0 0/2px 2px,
    repeating-linear-gradient(45deg,#cfd7d3 0,#cfd7d3 2px,#d9e1dd 2px,#d9e1dd 4px)}
  .menubar{height:var(--barH);display:flex;align-items:center;gap:10px;padding:0 6px;
    background:linear-gradient(#e7ecea,#d9e1dd);border-bottom:1px solid #000;user-select:none}
  .menu{position:relative;padding:1px 5px;border:1px solid transparent;cursor:default}
  .menu:hover{border-color:#9aa09d;background:#f4f7f6}
  .dropdown{position:absolute;top:100%;left:0;background:#f7fbf9;border:1px solid #000;box-shadow:2px 2px 0 #000;min-width:140px;display:none;z-index:10000}
  .menu[aria-expanded="true"] .dropdown,.menu:hover .dropdown{display:block}
  .dropdown button{all:unset;display:block;width:100%;padding:4px 6px;cursor:default}
  .dropdown button:hover{background:#cfe0ff}
  .spacer{flex:1}.clock{padding:1px 6px;border:1px solid #9aa09d;background:#f4f7f6;min-width:84px;text-align:center}
  .work{position:relative;flex:1 1 auto;overflow:hidden;padding:8px}

  .icon{position:absolute;width:66px;cursor:grab;user-select:none;text-align:center;touch-action:none}
  .glyph{width:40px;height:34px;margin:0 auto;border:1px solid #000;box-shadow:2px 2px 0 #000;background:#eef2f0;display:flex;align-items:center;justify-content:center}
  .label{margin-top:2px;border:1px solid #000;background:#f0f6ff;padding:1px 2px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
  .icon.selected .label{background:#aecdff}

  .dock{position:absolute;right:8px;bottom:8px;display:flex;gap:6px;padding:3px 4px;background:#eef2f0;border:1px solid #000;box-shadow:2px 2px 0 #000}
  .dock .task{padding:2px 5px;border:1px solid #000;background:#fff;cursor:default}
  .dock .task:hover{background:#cfe0ff}

  .win{position:absolute;min-width:200px;min-height:120px;width:360px;height:220px;top:70px;left:80px;
    background:#fff;border:1px solid #000;box-shadow:4px 4px 0 #000;display:flex;flex-direction:column;contain:layout paint size;
    transform-origin:top left;transition:transform .18s var(--ease),opacity .18s var(--ease),box-shadow .18s var(--ease)}
  .win.opening{transform:translateY(6px) scale(.97);box-shadow:0 0 0 #000}
  .win.closing{transform:translateY(6px) scale(.97);box-shadow:0 0 0 #000;opacity:0}
  .win.minimising{transform:scale(.9);opacity:0}
  .win.resizing{box-shadow:6px 6px 0 #000}
  .win.minimised{display:none}

  .titlebar{-webkit-app-region:drag;user-select:none;cursor:grab;flex:0 0 auto;display:flex;align-items:center;gap:6px;
    background:linear-gradient(#e7ecea,#d1dad6);border-bottom:1px solid #000;padding:2px 4px}
  .titlebar:active{cursor:grabbing}
  .title{font-weight:bold}.controls{margin-left:auto;display:flex;gap:4px}
  .btn{width:14px;height:14px;border:1px solid #000;background:#fff;display:grid;place-items:center;cursor:default;line-height:1}
  .btn:hover{background:#cfe0ff}
  .content{flex:1 1 auto;overflow:auto;padding:6px;background:#fff}
  .status{flex:0 0 auto;border-top:1px solid #000;background:#eef2f0;padding:2px 4px}
  .resize{position:absolute;width:12px;height:12px;right:0;bottom:0;cursor:nwse-resize;
    background:repeating-linear-gradient(135deg,#000 0,#000 1px,transparent 1px,transparent 3px)}
  .hidden{display:none!important}
  .maximised{top:var(--barH)!important;left:0!important;width:100%!important;height:calc(100% - var(--barH))!important}
  :focus-visible{outline:1px dashed #000;outline-offset:2px}
  @media (prefers-reduced-motion:reduce){.win{transition:none}}

  /* Panic banner for runtime errors */
  .panic{position:fixed;left:6px;bottom:6px;max-width:90vw;background:#000;color:#fff;border:1px solid #fff;padding:6px 8px;z-index:99999;font-size:10px}

  /* App-specific */
  .grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(120px,1fr));gap:8px}
  .file{border:1px solid #000;padding:5px;background:#f8fbfa;cursor:default}
  .file:hover{background:#cfe0ff}
  .row{display:flex;gap:6px;align-items:center}
  .fi{width:20px;height:20px;border:1px solid #000;background:#fff;box-shadow:1px 1px 0 #000}
  .name{font-weight:bold}
  .np-toolbar{display:flex;gap:6px;margin-bottom:6px}
  .np-toolbar button{all:unset;border:1px solid #000;padding:2px 5px;background:#fff;cursor:default}
  .np-toolbar button:hover{background:#cfe0ff}
  .np-area{width:100%;height:calc(100% - 46px);resize:none;border:1px solid #000;padding:5px;box-sizing:border-box;font:var(--fs)/1.3 ui-monospace,monospace}
  .calc{display:grid;grid-template-columns:repeat(4,1fr);gap:4px}
  .calc .display{grid-column:1/-1;border:1px solid #000;background:#e8efe9;padding:5px;text-align:right}
  .calc button{all:unset;border:1px solid #000;padding:6px;background:#fff;text-align:center;cursor:default}
  .calc button:hover{background:#cfe0ff}

  /* Canvas Editor */
  .ce-toolbar{display:flex;gap:6px;margin-bottom:6px;flex-wrap:wrap}
  .ce-toolbar button,.ce-toolbar select,.ce-toolbar input[type="color"]{
    all:unset;border:1px solid #000;padding:2px 5px;background:#fff;cursor:default}
  .ce-toolbar button:hover{background:#cfe0ff}
  .ce-wrap{position:relative; background:
      conic-gradient(from 45deg,#eee 0 25%,#ccc 0 50%,#eee 0 75%,#ccc 0) 0 0/12px 12px}
  .ce{display:block; background:#fff; image-rendering:pixelated; border:1px solid #000}

  /* Responsive adjustments */
  @media (max-width:900px){
    :root{--barH:28px;--fs:12px}
    html,body{overflow:auto;font-size:12px;background:#e6ece9}
    #desktop{background:linear-gradient(0deg,transparent 50%,rgba(0,0,0,.04) 50%) 0 0/2px 2px,
      repeating-linear-gradient(45deg,#dbe3df 0,#dbe3df 2px,#e5ede9 2px,#e5ede9 4px)}
    .menubar{flex-wrap:wrap;gap:6px;height:auto;line-height:1.2;border-bottom-width:2px}
    .menu{padding:4px 8px;border-radius:6px;font-size:12px;background:#f7fbf9}
    .dropdown{position:relative;box-shadow:none;margin-top:4px;border-radius:6px}
    .spacer{display:none}
    .clock{margin-left:auto;border-radius:6px;font-weight:600}
    .work{padding:10px 10px 70px;display:grid;gap:12px;
      grid-template-columns:repeat(auto-fit,minmax(120px,1fr));align-content:start;overflow:auto}
    .icon{position:static;width:100%;max-width:180px;margin:0 auto;text-align:center;cursor:pointer}
    .glyph{width:48px;height:40px;border-radius:8px}
    .label{font-weight:600;border-radius:8px;padding:4px 6px}
    .dock{position:static;width:100%;justify-content:flex-start;gap:8px;box-shadow:none;border-radius:10px}
    .dock .task{flex:1;text-align:center;border-radius:8px;padding:6px 8px}
    .win{width:calc(100% - 24px)!important;left:12px!important;right:12px!important;
      height:70vh;top:calc(var(--barH) + 12px)!important;min-width:auto;border-radius:14px;box-shadow:2px 6px 0 #000}
    .titlebar{border-radius:12px 12px 0 0;padding:6px 8px;gap:10px}
    .title{font-size:13px}
    .btn{width:18px;height:18px;border-radius:6px}
    .content{padding:10px;font-size:13px}
    .status{font-size:12px;border-radius:0 0 12px 12px}
  }
</style>
</head>
<body>
<div id="desktop">
  <div class="menubar" role="menubar" aria-label="geOS Menu">
    <div class="menu" tabindex="0" aria-expanded="false">geos
      <div class="dropdown" role="menu">
        <button data-menu="about">About geOS…</button>
        <button data-menu="new-note">New Note</button>
        <button data-menu="new-canvas">New Canvas</button>
        <button data-menu="open-files">Open File Manager</button>
        <button data-menu="open-press">Open Press Suite</button>
        <button data-menu="open-bookbuilder">Open BookBuilder</button>
        <button data-menu="reset">Reset Storage</button>
        <button data-menu="shutdown">Close All</button>
      </div>
    </div>
    <div class="menu" tabindex="0" aria-expanded="false">file
      <div class="dropdown">
        <button data-menu="new-note">New Note</button>
        <button data-menu="new-canvas">New Canvas</button>
        <button data-menu="open-files">Open File Manager</button>
        <button data-menu="open-press">Open Press Suite</button>
        <button data-menu="open-bookbuilder">Open BookBuilder</button>
      </div>
    </div>
    <div class="menu" tabindex="0" aria-expanded="false">view
      <div class="dropdown">
        <button data-menu="tile">Tile Windows</button>
        <button data-menu="cascade">Cascade Windows</button>
      </div>
    </div>
    <div class="spacer"></div>
    <div class="clock" aria-live="polite">--:--:--</div>
  </div>

  <div class="work" id="work">
    <!-- Desktop icons -->
    <div class="icon" style="left:12px;top:14px" data-launch="files">
      <div class="glyph" data-svg="folder"></div><div class="label">Desk Top</div>
    </div>
    <div class="icon" style="left:12px;top:98px" data-launch="note">
      <div class="glyph" data-svg="note"></div><div class="label">Note Pad</div>
    </div>
    <div class="icon" style="left:12px;top:182px" data-launch="calc">
      <div class="glyph" data-svg="calc"></div><div class="label">Calculator</div>
    </div>
    <div class="icon" style="left:12px;top:266px" data-launch="canvas">
      <div class="glyph" data-svg="canvas"></div><div class="label">Canvas</div>
    </div>
    <div class="icon" style="left:12px;top:350px" data-launch="press">
      <div class="glyph" data-svg="press"></div><div class="label">Press Suite</div>
    </div>
    <div class="icon" style="left:12px;top:434px" data-launch="bookbuilder">
      <div class="glyph" data-svg="book"></div><div class="label">BookBuilder</div>
    </div>
    <div class="dock" id="dock" aria-label="Minimised Windows Dock"></div>
  </div>
</div>

<script>
(() => {
  'use strict';

  /* ---------- Panic banner ---------- */
  function panic(msg){
    try{
      const d=document.createElement('div'); d.className='panic';
      d.textContent = 'Error: ' + (msg && (msg.stack||msg)) ;
      document.body.appendChild(d);
    }catch{}
  }
  window.addEventListener('error', e=>panic(e.error||e.message));
  window.addEventListener('unhandledrejection', e=>panic(e.reason||'unhandled promise rejection'));

  /* ---------- Safe storage ---------- */
  function makeSafeStorage(){
    try{ const k='__geos_test__'+Math.random(); localStorage.setItem(k,'1'); localStorage.removeItem(k); return localStorage; }
    catch{ const mem={}; return {getItem:k=>k in mem?mem[k]:null,setItem:(k,v)=>{mem[k]=String(v)},removeItem:k=>{delete mem[k]}}; }
  }
  const storage = makeSafeStorage();

  /* ---------- Helpers ---------- */
  const $$=(s,r=document)=>Array.from(r.querySelectorAll(s));
  const clamp=(v,min,max)=>Math.max(min,Math.min(max,v));
  const desktop=document.getElementById('work');
  const menubar=document.querySelector('.menubar');
  const clockEl=document.querySelector('.clock');
  const isTouch = navigator.maxTouchPoints>0;
  let zCounter=10;
  let skipNextIconClick=false;

  function appUrlCandidates(filename){
    const base=document.querySelector('base')?.href || document.baseURI || window.location.href;
    const baseRoot=new URL('./', base);
    const paths=[`app-data/${filename}`, `public/app-data/${filename}`];
    const urls=paths.map(p=>new URL(p, baseRoot).toString());
    const originRoot=new URL('./', window.location.origin+'/');
    for(const p of paths){
      const url=new URL(p, originRoot).toString();
      if(!urls.includes(url)) urls.push(url);
    }
    return urls;
  }

  function makeHtmlLoader(filename){
    let cache=null;
    return async function(){
      if(!cache){
        cache=(async()=>{
          for(const url of appUrlCandidates(filename)){
            try{
              const res=await fetch(url);
              if(!res.ok){ console.warn(filename,'missing at', url); continue; }
              return await res.text();
            }catch(err){
              console.warn('Failed to load app', filename, err);
            }
          }
          return null;
        })();
      }
      return cache;
    };
  }

  /* ---------- SVG icons ---------- */
  const ICONS={
    folder:`<svg viewBox="0 0 48 36" width="36" height="28" xmlns="http://www.w3.org/2000/svg" aria-hidden="true">
      <path d="M2 10h44v22H2z" fill="#fff" stroke="#000"/><path d="M2 10h18l3-5h12l3 5h8v4H2z" fill="#e8d39a" stroke="#000"/>
      <path d="M2 32h44v2H2z" fill="#b9a66a"/></svg>`,
    note:`<svg viewBox="0 0 48 36" width="36" height="28" xmlns="http://www.w3.org/2000/svg" aria-hidden="true">
      <rect x="6" y="4" width="30" height="28" fill="#fff" stroke="#000"/>
      <path d="M36 4v10h10" fill="#f4f4f4" stroke="#000"/>
      <path d="M10 10h18M10 16h18M10 22h18" stroke="#6a6a6a"/>
      <path d="M40 26l-8 6 2-9 11-11 3 3-11 11z" fill="#f2c38a" stroke="#000"/></svg>`,
    calc:`<svg viewBox="0 0 48 36" width="36" height="28" xmlns="http://www.w3.org/2000/svg" aria-hidden="true">
      <rect x="8" y="4" width="32" height="28" rx="2" fill="#e6eef2" stroke="#000"/>
      <rect x="12" y="8" width="24" height="6" fill="#cfe0e8" stroke="#000"/>
      <g fill="#fff" stroke="#000">
        <rect x="12" y="16" width="6" height="6"/><rect x="20" y="16" width="6" height="6"/><rect x="28" y="16" width="6" height="6"/>
        <rect x="12" y="24" width="6" height="6"/><rect x="20" y="24" width="6" height="6"/><rect x="28" y="24" width="6" height="6"/>
      </g></svg>`,
    canvas:`<svg viewBox="0 0 48 36" width="36" height="28" xmlns="http://www.w3.org/2000/svg" aria-hidden="true">
      <rect x="6" y="6" width="36" height="24" fill="#fff" stroke="#000"/>
      <path d="M6 6h36v6H6z" fill="#e8eef7" stroke="#000"/>
      <circle cx="13" cy="9" r="2" fill="#ff4343" stroke="#000"/>
      <circle cx="19" cy="9" r="2" fill="#ffcf33" stroke="#000"/>
      <circle cx="25" cy="9" r="2" fill="#33cc66" stroke="#000"/>
      <path d="M10 24c5-6 10-3 16-8 3-3 6-4 10-1" stroke="#6a6a6a" fill="none"/>
      <path d="M35 29l6-5" stroke="#000" />
      <path d="M41 24l-8 6 3-9 7 3z" fill="#f2c38a" stroke="#000"/>
    </svg>`,
    press:`<svg viewBox="0 0 48 36" width="36" height="28" xmlns="http://www.w3.org/2000/svg" aria-hidden="true">
      <rect x="4" y="4" width="40" height="28" rx="2" fill="#fff" stroke="#000"/>
      <path d="M6 8h36" stroke="#000"/>
      <path d="M8 12h20M8 16h28M8 20h24M8 24h30" stroke="#555"/>
      <rect x="30" y="12" width="10" height="10" fill="#e8d39a" stroke="#000"/>
      <path d="M30 22h10l-2 6H32z" fill="#d2e5f9" stroke="#000"/>
    </svg>`,
    book:`<svg viewBox="0 0 48 36" width="36" height="28" xmlns="http://www.w3.org/2000/svg" aria-hidden="true">
      <rect x="6" y="6" width="36" height="24" rx="2" fill="#fff" stroke="#000"/>
      <path d="M24 6v24" stroke="#000"/>
      <path d="M10 10h10M10 14h10M10 18h10M28 10h8M28 14h8M28 18h8" stroke="#6a6a6a"/>
      <path d="M24 6c0 2-2 3-4 3H8" fill="none" stroke="#000"/>
      <path d="M24 6c0 2 2 3 4 3h12" fill="none" stroke="#000"/>
    </svg>`
  };
  $$('[data-svg]').forEach(g=>g.innerHTML=ICONS[g.dataset.svg]||'');

  /* ---------- Tiny FS ---------- */
  const FS_KEY='geOS.fs.v1';
  const fs = (()=> {
    const defaults={seq:4,files:{
      1:{id:1,name:'welcome.txt',type:'txt',content:`Welcome to geOS v0.0.3!

• Tap on mobile; double-click on desktop.
• Apps: File Manager, Note Pad, Calculator, Canvas Editor.
• Storage survives refresh (unless content://), with RAM fallback.`},
      2:{id:2,name:'readme.txt',type:'txt',content:'Single-file retro desktop. Safe-storage wrapper enables running from content://.'},
      3:{id:3,name:'numbers.txt',type:'txt',content:'3.14159\n2.71828\n1.61803'},
      4:{id:4,name:'sample.png',type:'img',content:''}
    },desktop:[1,2,3]};
    let state; try{ state = JSON.parse(storage.getItem(FS_KEY)||'null') || defaults; }catch{ state=defaults; }
    const save=()=>{ try{ storage.setItem(FS_KEY, JSON.stringify(state)); }catch{} };
    return {
      list:()=>state.desktop.map(id=>state.files[id]).filter(Boolean),
      all:()=>Object.values(state.files),
      newNote:(name='note.txt',content='')=>{const id=++state.seq; state.files[id]={id,name,type:'txt',content}; state.desktop.push(id); save(); return state.files[id];},
      newImage:(name='canvas.png',dataURL='')=>{const id=++state.seq; state.files[id]={id,name,type:'img',content:dataURL}; state.desktop.push(id); save(); return state.files[id];},
      read:id=>state.files[id],
      write:(id,c)=>{ if(state.files[id]){ state.files[id].content=c; save(); }},
      rename:(id,n)=>{ if(state.files[id]){ state.files[id].name=n; save(); }},
      setType:(id,t)=>{ if(state.files[id]){ state.files[id].type=t; save(); }},
      remove:(id)=>{ delete state.files[id]; state.desktop=state.desktop.filter(x=>x!==id); save(); },
      reset:()=>{ try{ storage.removeItem(FS_KEY); }catch{} location.reload(); }
    }
  })();

  /* ---------- Window Manager ---------- */
  const WM = (()=> {
    const dock=document.getElementById('dock'); const windows=new Set();
    function createWindow({title,width=360,height=220,left=80,top=70,content,appId}){
      const el=document.createElement('div'); el.className='win opening';
      Object.assign(el.style,{width:width+'px',height:height+'px',left:left+'px',top:top+'px'});
      el.dataset.appId=appId||'';
      el.innerHTML=`<div class="titlebar"><span class="title">${title}</span>
        <div class="controls"><div class="btn" data-act="min">_</div><div class="btn" data-act="max">▢</div><div class="btn" data-act="close">×</div></div></div>
        <div class="content"></div><div class="status"></div><div class="resize" title="Resize"></div>`;
      desktop.appendChild(el); el.querySelector('.content').appendChild(content);
      requestAnimationFrame(()=>el.classList.remove('opening'));
      focus(el); enableDrag(el); enableResize(el);
      el.addEventListener('pointerdown',()=>focus(el));
      el.addEventListener('click',e=>{
        const act=e.target?.dataset?.act;
        if(act==='max') toggleMaximise(el);
        if(act==='min') minimise(el);
        if(act==='close') gracefulClose(el);
      });
      windows.add(el); return el;
    }
    function toggleMaximise(win){ win.classList.toggle('maximised'); }
    function focus(win){ zCounter+=1; win.style.zIndex=String(zCounter); }
    function bounds(el,x,y){
      const r=el.getBoundingClientRect();
      const minX=0;
      const minY=0; // allow windows to sit flush with the top edge
      const maxX=Math.max(minX, desktop.clientWidth - r.width);
      const maxY=Math.max(minY, desktop.clientHeight - r.height);
      return {x:clamp(x,minX,maxX), y:clamp(y,minY,maxY)};
    }
    function enableDrag(win){
      const bar=win.querySelector('.titlebar');
      bar.addEventListener('pointerdown',e=>{
        if(e.button!==0) return;
        // Don't initiate drag when clicking the window controls
        if(e.target?.closest('.controls')) return;
        const rect=win.getBoundingClientRect(); const offX=e.clientX-rect.left, offY=e.clientY-rect.top;
        win.setPointerCapture(e.pointerId);
        const move=ev=>{ const {x,y}=bounds(win,ev.clientX-offX,ev.clientY-offY); win.style.left=x+'px'; win.style.top=y+'px'; };
        const up=()=>{ win.releasePointerCapture(e.pointerId); win.removeEventListener('pointermove',move); win.removeEventListener('pointerup',up); };
        win.addEventListener('pointermove',move); win.addEventListener('pointerup',up);
      });
    }
    function enableResize(win){
      const grip=win.querySelector('.resize');
      grip.addEventListener('pointerdown',e=>{
        if(e.button!==0) return; win.classList.add('resizing');
        const s=win.getBoundingClientRect(), sx=e.clientX, sy=e.clientY; win.setPointerCapture(e.pointerId);
        const move=ev=>{ win.style.width=clamp(s.width+(ev.clientX-sx),200,desktop.clientWidth-s.left)+'px';
                         win.style.height=clamp(s.height+(ev.clientY-sy),120,desktop.clientHeight-s.top)+'px'; };
        const up=()=>{ win.classList.remove('resizing'); win.releasePointerCapture(e.pointerId); win.removeEventListener('pointermove',move); win.removeEventListener('pointerup',up); };
        win.addEventListener('pointermove',move); win.addEventListener('pointerup',up);
      });
    }
    function gracefulClose(win){
      const id=win.dataset.taskId, btn=id&&document.querySelector(`[data-task="${id}"]`); btn?.remove();
      win.classList.add('closing'); win.addEventListener('transitionend',()=>win.remove(),{once:true});
    }
    function minimise(win){
      if(win.classList.contains('minimised')) return;
      const id=Math.random().toString(36).slice(2,7); win.dataset.taskId=id;
      const t=document.createElement('button'); t.className='task'; t.textContent=win.querySelector('.title').textContent; t.dataset.task=id;
      t.addEventListener('click',()=>{ win.classList.remove('minimised'); t.remove(); focus(win); });
      dock.appendChild(t); win.classList.add('minimising'); setTimeout(()=>{ win.classList.remove('minimising'); win.classList.add('minimised'); },180);
    }
    function tile(){ const arr=[...document.querySelectorAll('.win')]; if(!arr.length) return;
      const cols=Math.ceil(Math.sqrt(arr.length)), rows=Math.ceil(arr.length/cols);
      const w=Math.floor(desktop.clientWidth/cols), h=Math.floor((desktop.clientHeight-menubar.offsetHeight)/rows);
      arr.forEach((win,i)=>{ const c=i%cols,r=Math.floor(i/cols);
        Object.assign(win.style,{left:(c*w)+'px',top:(menubar.offsetHeight+r*h)+'px',width:(w-4)+'px',height:(h-4)+'px'});
        win.classList.remove('maximised'); });
    }
    function cascade(){ let x=8,y=menubar.offsetHeight+8,step=22;
      [...document.querySelectorAll('.win')].forEach(w=>{ Object.assign(w.style,{left:x+'px',top:y+'px',width:'420px',height:'260px'}); x+=step;y+=step; w.classList.remove('maximised');});
    }
    return {createWindow,tile,cascade,gracefulClose};
  })();

  /* ---------- Apps ---------- */
  function openAbout(){
    const box=document.createElement('div');
    box.innerHTML=`<h3 style="margin:0 0 6px">geOS — Tiny UI (v0.0.3)</h3>
      <p style="margin:0 0 6px">Single-file retro desktop. Works from file managers (content://) via safe-storage. Includes Canvas Editor.</p>
      <p style="margin:0">© Atlas</p>`;
    WM.createWindow({title:'About geOS',width:320,height:160,left:120,top:80,content:box,appId:'about'});
  }

  // File Manager with image open
  function openFiles(){
    const wrap=document.createElement('div'), toolbar=document.createElement('div'); toolbar.className='np-toolbar';
    toolbar.innerHTML=`<button data-a="new">New Note</button><button data-a="canvas">New Canvas</button>
      <button data-a="refresh">Refresh</button><button data-a="export">Export FS</button><button data-a="import">Import FS</button>`;
    const grid=document.createElement('div'); grid.className='grid'; wrap.appendChild(toolbar); wrap.appendChild(grid);
    function render(){ grid.innerHTML='';
      fs.all().forEach(file=>{
        const card=document.createElement('div'); card.className='file';
        card.innerHTML=`<div class="row"><div class="fi"></div><div class="name">${file.name}</div></div>
          <div class="meta">type: ${file.type} • id: ${file.id}</div>
          <div class="row" style="margin-top:5px;gap:5px">
            <button data-op="open">Open</button><button data-op="ren">Rename</button><button data-op="del">Delete</button></div>`;
        card.querySelector('[data-op="open"]').onclick=()=>{ file.type==='img'?openImage(file.id):openNote(file.id); };
        card.querySelector('[data-op="ren"]').onclick=()=>{ const n=prompt('New name:',file.name); if(n){ fs.rename(file.id,n); render(); }};
        card.querySelector('[data-op="del"]').onclick=()=>{ if(confirm('Delete '+file.name+'?')){ fs.remove(file.id); render(); }};
        grid.appendChild(card);
      });
    }
    toolbar.addEventListener('click',(e)=>{
      const a=e.target?.dataset?.a;
      if(a==='new'){ const f=fs.newNote('note-'+(Date.now()%100000)+'.txt',''); render(); openNote(f.id); }
      if(a==='canvas'){ const f=fs.newImage('canvas-'+(Date.now()%100000)+'.png',''); render(); openCanvas(f.id); }
      if(a==='refresh'){ render(); }
      if(a==='export'){ try{ const data=storage.getItem('geOS.fs.v1')||'{}'; const blob=new Blob([data],{type:'application/json'});
        const url=URL.createObjectURL(blob); const a=document.createElement('a'); a.href=url; a.download='geOS-fs.json'; a.click(); URL.revokeObjectURL(url); }catch{ alert('Export not available'); } }
      if(a==='import'){ const inp=document.createElement('input'); inp.type='file'; inp.accept='application/json';
        inp.onchange=()=>{ const f=inp.files[0]; if(!f) return; const r=new FileReader();
          r.onload=()=>{ try{ JSON.parse(r.result); storage.setItem('geOS.fs.v1', r.result); location.reload(); }catch{ alert('Invalid file'); } };
          r.readAsText(f); }; inp.click(); }
    });
    WM.createWindow({title:'Desk Top — File Manager',width:560,height:340,left:160,top:90,content:wrap,appId:'files'}); render();
  }

  function openNote(id){
    const file=id?fs.read(id):fs.newNote();
    const wrap=document.createElement('div'), bar=document.createElement('div'); bar.className='np-toolbar';
    bar.innerHTML=`<button data-a="save">Save</button><button data-a="revert">Revert</button>
      <button data-a="wrap">Toggle Wrap</button><span style="margin-left:auto">File: <b>${file.name}</b></span>`;
    const ta=document.createElement('textarea'); ta.className='np-area'; ta.value=file.content; wrap.appendChild(bar); wrap.appendChild(ta);
    let wrapOn=true; bar.addEventListener('click',(e)=>{ const a=e.target?.dataset?.a;
      if(a==='save'){ fs.write(file.id, ta.value); }
      if(a==='revert'){ ta.value=fs.read(file.id).content; }
      if(a==='wrap'){ wrapOn=!wrapOn; ta.style.whiteSpace=wrapOn?'pre-wrap':'pre'; }});
    const win=WM.createWindow({title:'Note Pad — '+file.name,width:580,height:340,left:100+((Math.random()*60)|0),top:80+((Math.random()*40)|0),content:wrap,appId:'note'});
    win.addEventListener('keydown',(e)=>{ if((e.ctrlKey||e.metaKey)&&e.key.toLowerCase()==='s'){ e.preventDefault(); fs.write(file.id, ta.value); }});
    ta.focus();
  }

  function openImage(id){
    const file=fs.read(id); const box=document.createElement('div');
    box.innerHTML=`<div class="np-toolbar">
      <button data-a="export">Export PNG</button>
      <button data-a="edit">Edit in Canvas</button>
      <span style="margin-left:auto">Image: <b>${file.name}</b></span></div>
      <img alt="${file.name}" style="max-width:100%;height:auto;border:1px solid #000;image-rendering:pixelated" />`;
    const img=box.querySelector('img'); img.src=file.content||'';
    const win=WM.createWindow({title:'Image Viewer — '+file.name,width:520,height:360,left:220,top:110,content:box,appId:'img'});
    box.querySelector('[data-a="export"]').onclick=()=>{ if(!file.content){ alert('Empty image'); return; }
      const a=document.createElement('a'); a.href=file.content; a.download=file.name; a.click(); };
    box.querySelector('[data-a="edit"]').onclick=()=>openCanvas(file.id);
  }

  // Calculator
  function openCalc(){
    const box=document.createElement('div');
    box.innerHTML=`<div class="calc">
      <div class="display" id="disp">0</div>
      <button>7</button><button>8</button><button>9</button><button>÷</button>
      <button>4</button><button>5</button><button>6</button><button>×</button>
      <button>1</button><button>2</button><button>3</button><button>−</button>
      <button>0</button><button>.</button><button>=</button><button>+</button>
    </div>`;
    const disp=box.querySelector('#disp'); let a=null,op=null,fresh=true;
    const get=()=>parseFloat(disp.textContent.replace(',','.'))||0; const set=v=>disp.textContent=String(v);
    const apply=()=>{ const b=get(); if(op==='+') set(a+b); if(op==='−') set(a-b); if(op==='×') set(a*b); if(op==='÷') set(b===0?'∞':(a/b)); a=null; op=null; fresh=true; };
    box.addEventListener('click',(e)=>{ const t=e.target; if(t.tagName!=='BUTTON') return; const v=t.textContent;
      if(/[0-9]/.test(v)){ set(fresh?v:(disp.textContent+v)); fresh=false; return; }
      if(v==='.') { if(!disp.textContent.includes('.')) set(disp.textContent+'.'); fresh=false; return; }
      if(v==='='){ if(op!==null) apply(); return; }
      if('+-−×÷'.includes(v)){ a=get(); op=v; fresh=true; }});
    WM.createWindow({title:'Calculator',width:230,height:220,left:400,top:110,content:box,appId:'calc'});
  }

  // Canvas Editor
  function openCanvas(id){
    const existing = id && fs.read(id);
    let file = existing || fs.newImage('canvas-'+(Date.now()%100000)+'.png','');

    const wrap=document.createElement('div');
    const bar=document.createElement('div'); bar.className='ce-toolbar';
    bar.innerHTML=`<button data-a="save">Save</button>
      <button data-a="export">Export PNG</button>
      <button data-a="clear">Clear</button>
      <label>Tool:
        <select data-a="tool">
          <option>Pen</option><option>Eraser</option><option>Line</option><option>Rect</option>
        </select>
      </label>
      <label>Size:
        <select data-a="size"><option>1</option><option>2</option><option selected>3</option><option>4</option><option>8</option></select>
      </label>
      <label>Color: <input type="color" value="#000000" data-a="color"/></label>
      <button data-a="resize">Resize</button>
      <span style="margin-left:auto">File: <b>${file.name}</b></span>`;
    const stage=document.createElement('div'); stage.className='ce-wrap';
    const canvas=document.createElement('canvas'); canvas.className='ce'; canvas.width= existing?.content ? 640 : 480; canvas.height= existing?.content ? 360 : 270;
    stage.appendChild(canvas); wrap.appendChild(bar); wrap.appendChild(stage);

    const ctx=canvas.getContext('2d',{willReadFrequently:true});
    ctx.fillStyle='#ffffff'; ctx.fillRect(0,0,canvas.width,canvas.height);
    if(existing?.content){ const img=new Image(); img.onload=()=>{ ctx.drawImage(img,0,0); }; img.src=existing.content; }

    // tools
    let tool='Pen', size=3, color='#000000', drawing=false, last=null, snapshot=null, startPt=null;
    const setSnapshot=()=>{ snapshot=ctx.getImageData(0,0,canvas.width,canvas.height); };
    const restore=()=>{ if(snapshot) ctx.putImageData(snapshot,0,0); };
    function line(a,b){ ctx.beginPath(); ctx.moveTo(a.x,a.y); ctx.lineTo(b.x,b.y); ctx.lineWidth=size; ctx.strokeStyle=color; ctx.lineCap='round'; ctx.stroke(); }
    function rect(a,b){ ctx.lineWidth=size; ctx.strokeStyle=color; restore(); ctx.strokeRect(Math.min(a.x,b.x),Math.min(a.y,b.y),Math.abs(b.x-a.x),Math.abs(b.y-a.y)); }
    const pointerPos=(ev)=>{
      const r=canvas.getBoundingClientRect(); return {x: Math.round((ev.clientX-r.left)), y: Math.round((ev.clientY-r.top))};
    };
    canvas.addEventListener('pointerdown',e=>{
      canvas.setPointerCapture(e.pointerId);
      drawing=true; last=pointerPos(e); startPt=last;
      if(tool==='Line'||tool==='Rect') setSnapshot();
      if(tool==='Pen'||tool==='Eraser'){ ctx.strokeStyle= tool==='Eraser' ? '#ffffff' : color; ctx.lineWidth=size; ctx.lineCap='round'; ctx.beginPath(); ctx.moveTo(last.x,last.y); }
    });
    canvas.addEventListener('pointermove',e=>{
      if(!drawing) return; const p=pointerPos(e);
      if(tool==='Pen'||tool==='Eraser'){ ctx.lineTo(p.x,p.y); ctx.stroke(); last=p; return; }
      if(tool==='Line'){ restore(); line(startPt,p); return; }
      if(tool==='Rect'){ rect(startPt,p); return; }
    });
    canvas.addEventListener('pointerup',e=>{
      if(!drawing) return; drawing=false; const p=pointerPos(e);
      if(tool==='Line'){ restore(); line(startPt,p); }
      if(tool==='Rect'){ rect(startPt,p); }
    });

    bar.addEventListener('change',(e)=>{
      const a=e.target?.dataset?.a;
      if(a==='tool') tool=e.target.value;
      if(a==='size') size=parseInt(e.target.value,10)||1;
      if(a==='color') color=e.target.value;
    });
    bar.addEventListener('click',(e)=>{
      const a=e.target?.dataset?.a;
      if(a==='save'){ try{ const data=canvas.toDataURL('image/png'); fs.write(file.id,data); fs.setType(file.id,'img'); file=fs.read(file.id); }catch{} }
      if(a==='export'){ const data=canvas.toDataURL('image/png'); const a=document.createElement('a'); a.href=data; a.download=file.name; a.click(); }
      if(a==='clear'){ ctx.fillStyle='#ffffff'; ctx.fillRect(0,0,canvas.width,canvas.height); }
      if(a==='resize'){ const w=parseInt(prompt('Width px:', canvas.width)||canvas.width,10); const h=parseInt(prompt('Height px:', canvas.height)||canvas.height,10);
        if(w>0&&h>0){ const img=ctx.getImageData(0,0,canvas.width,canvas.height); const tmp=document.createElement('canvas'); tmp.width=w; tmp.height=h;
          const tctx=tmp.getContext('2d'); tctx.fillStyle='#ffffff'; tctx.fillRect(0,0,w,h);
          const s=document.createElement('canvas'); s.width=img.width; s.height=img.height; s.getContext('2d').putImageData(img,0,0);
          tctx.imageSmoothingEnabled=false; tctx.drawImage(s,0,0,w,h);
          canvas.width=w; canvas.height=h; ctx.imageSmoothingEnabled=false; ctx.drawImage(tmp,0,0); }
      }
      if(a==='color' || a==='size' || a==='tool'){} // handled in change
    });

    WM.createWindow({title:'Canvas Editor — '+file.name,width:720,height:500,left:90,top:70,content:wrap,appId:'canvas'});
  }

  /* ---------- External apps (Press + BookBuilder) ---------- */
  const loadPressHtml = makeHtmlLoader('karolco-press-v0.0.10.html');
  const loadBookBuilderHtml = makeHtmlLoader('mm-bookbuilder-v0.0.9.html');

  function openPress(){
    const wrap=document.createElement('div'); wrap.style.cssText='display:flex;flex-direction:column;height:100%';
    const bar=document.createElement('div'); bar.className='np-toolbar';
    bar.innerHTML=`<button data-a="reload">Reload</button>
      <button data-a="save">Save export to Desk</button>
      <button data-a="popout">Open in new tab</button>
      <span style="margin-left:auto" data-a="status">Loading press…</span>`;
    const iframe=document.createElement('iframe'); iframe.title='KarolCo Press'; iframe.setAttribute('aria-label','KarolCo Press newspaper builder');
    Object.assign(iframe.style,{flex:'1',border:'1px solid #000',background:'#111'});
    wrap.appendChild(bar); wrap.appendChild(iframe);

    WM.createWindow({title:'KarolCo Press — Newspaper Builder',width:980,height:720,left:140,top:60,content:wrap,appId:'press'});
    const status=()=>bar.querySelector('[data-a="status"]');

    function setStatus(msg){ const s=status(); if(s) s.textContent=msg; }
    function loadIntoFrame(){ setStatus('Loading press…'); loadPressHtml().then(html=>{
      if(!html){ setStatus('Failed to load press app'); return; }
      iframe.srcdoc=html; setStatus('Press ready — export with MDX or print');
    }); }

    function saveExport(){
      const doc=iframe.contentDocument; if(!doc){ setStatus('App not ready yet'); return; }
      const btn=doc.getElementById('exportXmd'); if(!btn){ setStatus('Export control unavailable'); return; }
      btn.click();
      setTimeout(()=>{
        const ta=doc.getElementById('xmdOutput');
        const val=ta?.value?.trim();
        if(!val){ setStatus('Nothing to save yet'); return; }
        const name='press-'+new Date().toISOString().replace(/[:T]/g,'-').slice(0,19)+'.mdx';
        const file=fs.newNote(name,val); fs.setType(file.id,'txt');
        setStatus('Saved to Desk: '+name);
      },80);
    }

    function popout(){
      loadPressHtml().then(html=>{
        if(!html){ setStatus('Cannot open in new tab (missing file)'); return; }
        const blob=new Blob([html],{type:'text/html'}); const url=URL.createObjectURL(blob);
        window.open(url,'_blank');
      });
    }

    bar.addEventListener('click',(e)=>{
      const act=e.target?.dataset?.a;
      if(act==='reload'){ loadIntoFrame(); }
      if(act==='save'){ saveExport(); }
      if(act==='popout'){ popout(); }
    });

    iframe.addEventListener('load',()=>setStatus('Press ready — export with MDX or print'));
    loadIntoFrame();
  }

  function openBookBuilder(){
    const wrap=document.createElement('div'); wrap.style.cssText='display:flex;flex-direction:column;height:100%';
    const bar=document.createElement('div'); bar.className='np-toolbar';
    bar.innerHTML=`<button data-a="reload">Reload</button>
      <button data-a="popout">Open in new tab</button>
      <span style="margin-left:auto" data-a="status">Loading BookBuilder…</span>`;
    const iframe=document.createElement('iframe'); iframe.title='MM BookBuilder'; iframe.setAttribute('aria-label','MM BookBuilder book mock-up');
    Object.assign(iframe.style,{flex:'1',border:'1px solid #000',background:'#111'});
    wrap.appendChild(bar); wrap.appendChild(iframe);

    WM.createWindow({title:'MM BookBuilder — Book layout',width:1080,height:760,left:120,top:70,content:wrap,appId:'bookbuilder'});
    const status=()=>bar.querySelector('[data-a="status"]');

    function setStatus(msg){ const s=status(); if(s) s.textContent=msg; }
    function loadIntoFrame(){ setStatus('Loading BookBuilder…'); loadBookBuilderHtml().then(html=>{
      if(!html){ setStatus('Failed to load BookBuilder'); return; }
      iframe.srcdoc=html; setStatus('BookBuilder ready — use in-app rebuild or PDF export');
    }); }

    function popout(){
      loadBookBuilderHtml().then(html=>{
        if(!html){ setStatus('Cannot open in new tab (missing file)'); return; }
        const blob=new Blob([html],{type:'text/html'}); const url=URL.createObjectURL(blob);
        window.open(url,'_blank');
      });
    }

    bar.addEventListener('click',(e)=>{
      const act=e.target?.dataset?.a;
      if(act==='reload'){ loadIntoFrame(); }
      if(act==='popout'){ popout(); }
    });

    iframe.addEventListener('load',()=>setStatus('BookBuilder ready — use in-app rebuild or PDF export'));
    loadIntoFrame();
  }

  /* ---------- Desktop interactions ---------- */
  function launch(id){ if(id==='files') openFiles(); if(id==='note') openNote(); if(id==='calc') openCalc(); if(id==='canvas') openCanvas(); if(id==='press') openPress(); if(id==='bookbuilder') openBookBuilder(); }
  let sel=null;
  desktop.addEventListener('click',(e)=>{
    if(skipNextIconClick){ skipNextIconClick=false; return; }
    const icon=e.target.closest('.icon'); if(sel) sel.classList.remove('selected'); if(icon){ sel=icon; sel.classList.add('selected'); }
  });
  if(isTouch){ desktop.addEventListener('click',(e)=>{ const ico=e.target.closest('.icon'); if(ico) launch(ico.dataset.launch); }); }
  else{ desktop.addEventListener('dblclick',(e)=>{ const ico=e.target.closest('.icon'); if(ico) launch(ico.dataset.launch); }); }

  function enableIconDrag(){
    desktop.querySelectorAll('.icon').forEach(icon=>{
      icon.addEventListener('pointerdown',e=>{
        if(e.button!==0) return;
        const bounds=desktop.getBoundingClientRect();
        const r=icon.getBoundingClientRect();
        const offX=e.clientX-r.left; const offY=e.clientY-r.top; let moved=false;
        icon.style.cursor='grabbing';
        icon.setPointerCapture(e.pointerId);
        const move=ev=>{
          const x=clamp(ev.clientX-bounds.left-offX,0,bounds.width-r.width);
          const y=clamp(ev.clientY-bounds.top-offY,0,bounds.height-r.height);
          icon.style.left=x+'px'; icon.style.top=y+'px'; moved=true;
        };
        const up=()=>{
          icon.style.cursor='grab';
          icon.releasePointerCapture(e.pointerId);
          icon.removeEventListener('pointermove',move);
          icon.removeEventListener('pointerup',up);
          if(moved){ skipNextIconClick=true; requestAnimationFrame(()=>skipNextIconClick=false); }
        };
        icon.addEventListener('pointermove',move);
        icon.addEventListener('pointerup',up);
      });
    });
  }
  enableIconDrag();

  /* ---------- Menus ---------- */
  for(const m of $$('.menu')){
    m.addEventListener('click',()=>{ const open=m.getAttribute('aria-expanded')==='true';
      $$('.menu').forEach(x=>x.setAttribute('aria-expanded','false')); m.setAttribute('aria-expanded', String(!open)); });
    m.addEventListener('keydown',(e)=>{ if(e.key==='Enter'||e.key===' '){ e.preventDefault(); m.click(); } });
  }
  document.addEventListener('click',(e)=>{ if(!e.target.closest('.menu')) $$('.menu').forEach(x=>x.setAttribute('aria-expanded','false')); });
  document.querySelectorAll('.dropdown button').forEach(b=>b.addEventListener('click',()=>{
    const act=b.dataset.menu;
    if(act==='about') openAbout();
    if(act==='new-note') openNote();
    if(act==='new-canvas') openCanvas();
    if(act==='open-files') openFiles();
    if(act==='open-press') openPress();
    if(act==='open-bookbuilder') openBookBuilder();
    if(act==='shutdown') $$('.win').forEach(w=>w.remove());
    if(act==='reset') fs.reset();
    if(act==='tile') WM.tile();
    if(act==='cascade') WM.cascade();
    $$('.menu').forEach(x=>x.setAttribute('aria-expanded','false'));
  }));

  /* ---------- Clock ---------- */
  (function tick(){ const d=new Date(),p=n=>String(n).padStart(2,'0');
    clockEl.textContent=`${p(d.getHours())}:${p(d.getMinutes())}:${p(d.getSeconds())}`;
    setTimeout(tick,500);
  })();

  /* ---------- Inject SVGs ---------- */
  $$('[data-svg]').forEach(g=>g.innerHTML=ICONS[g.dataset.svg]||'');
})();
</script>
</body>
</html>
